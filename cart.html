<!-- Scripts -->
<script>
    let productsLoaded = false;
    let cartInitialized = false;

    // Inicializar la aplicaci√≥n si no existe
    if (!window.ferreteriaApp) {
        // Cargar main.js din√°micamente
        const script = document.createElement('script');
        script.src = 'main.js';
        script.onload = function() {
            console.log('‚úÖ main.js cargado, esperando productos...');
            waitForProducts();
        };
        script.onerror = function() {
            console.error('‚ùå Error cargando main.js, usando fallback');
            initializeCartWithFallback();
        };
        document.head.appendChild(script);
    } else {
        console.log('‚úÖ ferreteriaApp ya existe, inicializando carrito...');
        waitForProducts();
    }

    function waitForProducts() {
        const maxWaitTime = 5000; // 5 segundos m√°ximo
        const startTime = Date.now();
        
        const checkProducts = () => {
            const products = window.ferreteriaApp?.products;
            
            if (products && products.length > 0) {
                console.log('‚úÖ Productos cargados:', products.length);
                productsLoaded = true;
                initializeCart();
            } else if (Date.now() - startTime < maxWaitTime) {
                // Esperar un poco m√°s
                setTimeout(checkProducts, 100);
            } else {
                console.warn('‚ö†Ô∏è Timeout esperando productos, usando fallback');
                initializeCartWithFallback();
            }
        };
        
        checkProducts();
    }

    function initializeCart() {
        if (cartInitialized) return;
        
        console.log('üõí Inicializando carrito con productos...');
        generateCartItems();
        updateCartSummary();
        bindCartEvents();
        updateCartUI();
        cartInitialized = true;
    }

    function initializeCartWithFallback() {
        console.log('üîß Usando modo fallback para carrito');
        generateCartItems();
        updateCartSummary();
        bindCartEvents();
        updateCartUI();
        cartInitialized = true;
    }
    
    function generateCartItems() {
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cart = window.ferreteriaApp?.cart || JSON.parse(localStorage.getItem('ferreteria_cart')) || [];
        const products = window.ferreteriaApp?.products || [];
        
        console.log('üõí Carrito actual:', cart);
        console.log('üì¶ Productos disponibles:', products.length);
        console.log('üîç IDs en carrito:', cart.map(item => item.productId));
        console.log('üîç IDs de productos:', products.map(p => p.id));
        
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = `
                <div class="empty-cart">
                    <svg class="empty-cart-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0V19a2 2 0 002 2h7a2 2 0 002-2v-4"></path>
                    </svg>
                    <h3 class="text-2xl font-bold text-gray-600 mb-4">Tu carrito est√° vac√≠o</h3>
                    <p class="text-gray-500 mb-6">A√∫n no has agregado productos a tu carrito</p>
                    <a href="index.html" class="btn-primary">Seguir Comprando</a>
                </div>
            `;
            return;
        }
        
        // Contar productos encontrados vs no encontrados
        let foundProducts = 0;
        let missingProducts = 0;
        
        const cartHTML = cart.map(cartItem => {
            const product = products.find(p => p.id === cartItem.productId);
            
            if (!product) {
                missingProducts++;
                return `
                    <div class="cart-item flex items-center p-6 mb-4">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg mb-1 font-inter text-red-600">Producto no disponible</h3>
                            <p class="text-gray-600 text-sm mb-2">ID: ${cartItem.productId}</p>
                            <p class="text-xs text-gray-500">Este producto ya no est√° disponible en el cat√°logo</p>
                        </div>
                        <div class="text-right mr-6">
                            <div class="price-tag mb-1 text-gray-400">
                                $${((cartItem.price || 0) * cartItem.quantity).toFixed(2)}
                            </div>
                        </div>
                        <button 
                            class="btn-danger" 
                            onclick="removeFromCart('${cartItem.productId}')"
                            title="Eliminar producto"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
            }
            
            foundProducts++;
            const stockStatus = product.stock > 10 ? 'success' : product.stock > 0 ? 'warning' : 'error';
            const stockText = product.stock > 10 ? 'Disponible' : product.stock > 0 ? 'Poco stock' : 'Agotado';
            const stockClass = product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-yellow-600' : 'text-red-600';
            
            return `
                <div class="cart-item flex items-center p-6 mb-4">
                    <img src="${product.image || 'resources/placeholder.jpg'}" alt="${product.name}" class="cart-image mr-6"
                         onerror="this.src='resources/placeholder.jpg'">
                    
                    <div class="flex-1">
                        <h3 class="font-bold text-lg mb-1 font-inter">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-2">${product.description}</p>
                        <p class="text-xs text-gray-500">C√≥digo: ${product.code}</p>
                        <p class="text-xs ${stockClass}">Stock: ${stockText} (${product.stock} disponibles)</p>
                    </div>
                    
                    <div class="flex items-center space-x-4 mx-6">
                        <div class="flex items-center space-x-2">
                            <button 
                                class="btn-secondary text-sm px-3 py-1" 
                                onclick="updateQuantity('${cartItem.productId}', ${cartItem.quantity - 1})"
                                ${cartItem.quantity <= 1 ? 'disabled' : ''}
                            >
                                -
                            </button>
                            <input 
                                type="number" 
                                class="quantity-input" 
                                value="${cartItem.quantity}" 
                                min="1" 
                                max="${product.stock}"
                                onchange="updateQuantity('${cartItem.productId}', this.value)"
                            >
                            <button 
                                class="btn-secondary text-sm px-3 py-1" 
                                onclick="updateQuantity('${cartItem.productId}', ${cartItem.quantity + 1})"
                                ${cartItem.quantity >= product.stock ? 'disabled' : ''}
                            >
                                +
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-right mr-6">
                        <div class="price-tag mb-1">
                            $${((product.price || 0) * cartItem.quantity).toFixed(2)}
                        </div>
                        <div class="text-sm text-gray-500">
                            $${(product.price || 0).toFixed(2)} c/u
                        </div>
                    </div>
                    
                    <button 
                        class="btn-danger" 
                        onclick="removeFromCart('${cartItem.productId}')"
                        title="Eliminar producto"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            `;
        }).join('');

        cartItemsContainer.innerHTML = cartHTML;

        // Mostrar resumen de productos encontrados
        console.log(`üìä Resumen: ${foundProducts} productos encontrados, ${missingProducts} no encontrados`);
        
        if (missingProducts > 0) {
            const warningMessage = document.createElement('div');
            warningMessage.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6';
            warningMessage.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-yellow-700 text-sm">
                        ${missingProducts} producto(s) no est√°n disponibles. Pueden haber sido removidos del cat√°logo.
                    </p>
                </div>
            `;
            cartItemsContainer.insertBefore(warningMessage, cartItemsContainer.firstChild);
        }

        // Si hay productos pero no se renderizaron, mostrar mensaje
        if (cart.length > 0 && cartItemsContainer.innerHTML.trim() === '') {
            cartItemsContainer.innerHTML = `
                <div class="empty-cart">
                    <h3 class="text-2xl font-bold text-gray-600 mb-4">Error al cargar productos</h3>
                    <p class="text-gray-500 mb-6">Recarga la p√°gina o intenta nuevamente</p>
                    <button onclick="location.reload()" class="btn-primary">Recargar P√°gina</button>
                </div>
            `;
        }
    }
    
    function updateCartSummary() {
        const cart = window.ferreteriaApp?.cart || JSON.parse(localStorage.getItem('ferreteria_cart')) || [];
        const products = window.ferreteriaApp?.products || [];
        
        const subtotal = cart.reduce((total, item) => {
            const product = products.find(p => p.id === item.productId);
            return total + ((product?.price || item.price || 0) * item.quantity);
        }, 0);
        
        const total = subtotal;
        
        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        
        // Enable/disable checkout button
        const checkoutBtn = document.getElementById('proceed-to-checkout');
        
        if (cart.length === 0) {
            checkoutBtn.disabled = true;
            checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            checkoutBtn.disabled = false;
            checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
    
    function bindCartEvents() {
        // Continue shopping button
        document.getElementById('continue-shopping').addEventListener('click', function() {
            window.location.href = 'index.html';
        });
        
        // Proceed to checkout button
        document.getElementById('proceed-to-checkout').addEventListener('click', function() {
            const cart = window.ferreteriaApp?.cart || JSON.parse(localStorage.getItem('ferreteria_cart')) || [];
            if (cart.length > 0) {
                // Verificar stock antes de proceder al pago
                if (checkStockAvailability()) {
                    window.location.href = 'checkout.html';
                } else {
                    showToast('Algunos productos no tienen stock suficiente', 'error');
                }
            } else {
                showToast('Tu carrito est√° vac√≠o', 'error');
            }
        });
    }

    function checkStockAvailability() {
        const cart = window.ferreteriaApp?.cart || JSON.parse(localStorage.getItem('ferreteria_cart')) || [];
        const products = window.ferreteriaApp?.products || [];
        
        for (const item of cart) {
            const product = products.find(p => p.id === item.productId);
            if (!product) {
                showToast('Algunos productos ya no est√°n disponibles', 'error');
                return false;
            }
            if (product.stock < item.quantity) {
                showToast(`Stock insuficiente para: ${product.name}`, 'error');
                return false;
            }
        }
        return true;
    }
    
    // Funciones globales para el carrito
    function removeFromCart(productId) {
        if (window.ferreteriaApp) {
            window.ferreteriaApp.removeFromCart(productId);
        } else {
            // Fallback: manejo directo del localStorage
            const cart = JSON.parse(localStorage.getItem('ferreteria_cart')) || [];
            const updatedCart = cart.filter(item => item.productId !== productId);
            localStorage.setItem('ferreteria_cart', JSON.stringify(updatedCart));
            
            // Mostrar toast
            showToast('Producto eliminado del carrito', 'success');
        }
        generateCartItems();
        updateCartSummary();
        updateCartUI();
    }
    
    function updateQuantity(productId, quantity) {
        const qty = parseInt(quantity);
        if (isNaN(qty) || qty < 0) return;
        
        if (window.ferreteriaApp) {
            window.ferreteriaApp.updateQuantity(productId, qty);
        } else {
            // Fallback: manejo directo del localStorage
            const cart = JSON.parse(localStorage.getItem('ferreteria_cart')) || [];
            const itemIndex = cart.findIndex(item => item.productId === productId);
            if (itemIndex !== -1) {
                if (qty <= 0) {
                    cart.splice(itemIndex, 1);
                    showToast('Producto eliminado del carrito', 'success');
                } else {
                    // Verificar stock m√°ximo
                    const products = window.ferreteriaApp?.products || [];
                    const product = products.find(p => p.id === productId);
                    const maxStock = product?.stock || 99;
                    
                    if (qty > maxStock) {
                        showToast(`No puedes agregar m√°s. Stock m√°ximo: ${maxStock}`, 'error');
                        return;
                    }
                    
                    cart[itemIndex].quantity = qty;
                }
                localStorage.setItem('ferreteria_cart', JSON.stringify(cart));
            }
        }
        generateCartItems();
        updateCartSummary();
        updateCartUI();
    }
    
    function updateCartUI() {
        const cartCount = document.getElementById('cart-count');
        const cart = JSON.parse(localStorage.getItem('ferreteria_cart')) || [];
        const count = cart.reduce((total, item) => total + item.quantity, 0);
        
        if (cartCount) {
            cartCount.textContent = count;
            cartCount.style.display = count > 0 ? 'block' : 'none';
        }
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <span class="toast-message">${message}</span>
                <button class="toast-close">&times;</button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        
        // Cerrar toast al hacer click en el bot√≥n
        toast.querySelector('.toast-close').addEventListener('click', function() {
            toast.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        });
        
        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
            if (document.body.contains(toast)) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }
        }, 5000);
    }
    
    // Inicializar cuando carga la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM cargado, iniciando proceso...');
        // La inicializaci√≥n se maneja autom√°ticamente arriba
    });

    // Forzar actualizaci√≥n si hay cambios en el localStorage
    window.addEventListener('storage', function(e) {
        if (e.key === 'ferreteria_cart') {
            initializeCart();
        }
    });

    // Tambi√©n escuchar cambios internos en el carrito
    if (window.ferreteriaApp) {
        const originalUpdateCartUI = window.ferreteriaApp.updateCartUI;
        window.ferreteriaApp.updateCartUI = function() {
            if (originalUpdateCartUI) {
                originalUpdateCartUI.call(this);
            }
            initializeCart();
        };
    }
</script>
